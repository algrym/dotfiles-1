#!/usr/bin/env bash
# Record active window or whole screen. Currently the recording is stuck at the
# windows initial possion.
#
# Requires ffmpeg, xrandr and Xorg

record() {
  ffmpeg -video_size "$wh" -framerate 30 -f x11grab -i "$DISPLAY$xy" -c:v libx264 -qp 0 -preset ultrafast ~/capture.mkv
}

get_win_dim() {
  xwininfo -id "$window_id" \
    | awk '/Absolute.*X:/ { x=$NF }
           /Absolute.*Y:/ { y=$NF }
           /Width:/ { w=$2 }
           /Height:/ { h=$2 }
           END { printf("%dx%d +%d,%d\n", w, h, x, y) }'
}

main() {
  f_focused=0

  if [ "$#" -gt 0 ]; then
    case $1 in
      --focused|-f)
        f_focused=1
        ;;
      *)
        >&2 echo "Usage: ${0##*/} [--delayed]"
        exit 1;
        ;;
    esac
  fi

  if [ "$f_focused" -eq 1 ]; then
    window_id=$(xprop -root | sed 's/_NET_ACTIVE_WINDOW(WINDOW): window id # \(.*\)/\1/p;d')
    read -r wh xy < <(get_win_dim "$window_id")
  else
    wh=$(xrandr | sed -n '/\*/{s/[^[:digit:]]*\([[:digit:]]*x[[:digit:]]*\).*/\1/p}')
    xy=
  fi


  record "$wh" "$xy"
}
main "$@"
